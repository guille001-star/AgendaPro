{% extends "base.html" %}
{% block content %}
<div class="min-h-screen flex items-center justify-center bg-slate-200 p-4">
    <div class="w-full max-w-md bg-white shadow-2xl overflow-hidden">
        <div class="bg-slate-900 p-10 text-center border-b-4 border-indigo-600">
            <span class="block text-xs font-bold text-indigo-400 uppercase tracking-[0.2em] mb-2">Reserva Profesional</span>
            <h1 class="text-3xl font-bold text-white tracking-tight">{{ professional.name }}</h1>
        </div>
        <div class="p-8 space-y-6 bg-white">
            <form action="{{ url_for('public.agenda', slug=professional.slug) }}" method="POST" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2 tracking-wide">Nombre Completo</label>
                    <input type="text" name="name" required class="block w-full px-0 py-3 text-slate-900 bg-transparent border-0 border-b-2 border-slate-200 focus:border-indigo-600 focus:ring-0 text-lg transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2 tracking-wide">Teléfono</label>
                    <input type="tel" name="phone" required class="block w-full px-0 py-3 text-slate-900 bg-transparent border-0 border-b-2 border-slate-200 focus:border-indigo-600 focus:ring-0 text-lg transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2 tracking-wide">Día</label>
                    <select name="date" id="date-select" required class="block w-full px-0 py-3 text-slate-900 bg-transparent border-0 border-b-2 border-slate-200 focus:border-indigo-600 focus:ring-0 text-lg transition cursor-pointer">
                        <option value="" disabled selected>Seleccionar fecha</option>
                        {% for d in enabled_dates %}
                        <option value="{{ d.date }}">{{ d.date|format_date }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="slots-container" class="hidden">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-3 tracking-wide">Horarios Disponibles</label>
                    <div id="slots-grid" class="grid grid-cols-3 gap-2"></div>
                    <input type="hidden" name="time_slot" id="time-slot-input">
                </div>
                
                <div id="notes-container" class="hidden">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-2 tracking-wide">Nota (Opcional)</label>
                    <textarea name="notes" rows="2" class="w-full border border-slate-200 rounded p-2 text-sm focus:ring-1 focus:ring-indigo-500 focus:outline-none resize-none"></textarea>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white py-4 rounded text-sm font-bold uppercase tracking-widest hover:bg-indigo-700 transition mt-4 shadow-lg disabled:opacity-50" disabled>
                    Confirmar Reserva
                </button>
            </form>
        </div>
    </div>
</div>
<script>
document.getElementById('date-select').addEventListener('change', function() {
    const date = this.value;
    const slug = "{{ professional.slug }}";
    const container = document.getElementById('slots-container');
    const notesContainer = document.getElementById('notes-container');
    const grid = document.getElementById('slots-grid');
    const submitBtn = document.getElementById('submit-btn');
    
    grid.innerHTML = '<p class="col-span-3 text-center text-slate-400 text-sm">Consultando servidor...</p>';
    container.classList.remove('hidden');
    notesContainer.classList.add('hidden');
    submitBtn.disabled = true;

    fetch(`/agenda/get-slots/${slug}/${date}`)
        .then(response => response.json())
        .then(data => {
            grid.innerHTML = '';
            if(data.slots && data.slots.length > 0){
                data.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.innerText = slot;
                    btn.className = 'border border-slate-300 rounded py-2 text-sm font-medium hover:bg-indigo-50 hover:border-indigo-500 hover:text-indigo-600 transition';
                    btn.onclick = function() {
                        document.querySelectorAll('#slots-grid button').forEach(b => b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600'));
                        this.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                        document.getElementById('time-slot-input').value = slot;
                        submitBtn.disabled = false;
                        notesContainer.classList.remove('hidden');
                    };
                    grid.appendChild(btn);
                });
            } else {
                // Mostramos el mensaje y el debug si existe
                let msg = data.message || 'Sin horarios.';
                let debugHtml = '';
                if(data.debug) {
                    debugHtml = `<div class="col-span-3 text-left text-xs text-gray-500 bg-gray-100 p-2 rounded mt-2 font-mono border border-dashed">
                        <b>Debug Info:</b><br>
                        Status: ${data.status}<br>
                        Start: ${data.debug.start_time || 'N/A'}<br>
                        End: ${data.debug.end_time || 'N/A'}<br>
                        Duration: ${data.debug.duration_min} min<br>
                        Booked: ${data.debug.booked_count}<br>
                        Server Time (UTC): ${data.debug.now_utc}
                    </div>`;
                }
                grid.innerHTML = `<div class="col-span-3"><p class="text-center text-red-500 text-sm">${msg}</p>${debugHtml}</div>`;
            }
        })
        .catch(err => {
            grid.innerHTML = '<p class="col-span-3 text-center text-red-500 text-sm">Error de conexión.</p>';
        });
});
</script>
{% endblock %}
