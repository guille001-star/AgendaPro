{% extends "base.html" %}
{% block content %}
<div class="flex flex-col lg:flex-row min-h-[calc(100vh-64px)]">
    
    <!-- Sidebar Oscuro (Config) -->
    <aside class="w-full lg:w-72 bg-slate-800 text-slate-200 p-6 border-r border-slate-700 flex-shrink-0 order-2 lg:order-1">
        <div class="mb-8">
            <h3 class="text-xs font-bold uppercase text-slate-500 mb-2 tracking-widest">Acceso Público</h3>
            <div class="bg-slate-900 p-3 rounded border border-slate-700">
                <input type="text" value="{{ public_url }}" readonly class="w-full bg-transparent text-indigo-400 font-mono text-xs focus:outline-none">
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xs font-bold uppercase text-slate-500 mb-4 tracking-widest">Parámetros</h3>
            <form action="{{ url_for('dashboard.settings') }}" method="POST" class="space-y-3">
                <label class="block text-sm text-slate-300">Duración del Turno</label>
                <div class="flex items-center gap-2">
                    <input type="number" name="duration" value="{{ current_user.appointment_duration }}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-center font-bold">
                    <span class="text-slate-400 text-xs">MIN</span>
                </div>
                <button type="submit" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs font-bold uppercase tracking-wide transition">Actualizar</button>
            </form>
        </div>
        
        <div class="bg-slate-900/50 p-4 rounded border border-slate-700 mt-6">
            <h4 class="text-xs font-bold text-indigo-400 mb-2 uppercase">Instrucciones</h4>
            <p class="text-xs text-slate-400 leading-relaxed">Haz clic en un día en el calendario de abajo para definir tus horarios de atención.</p>
        </div>
    </aside>

    <!-- Contenido Principal -->
    <div class="flex-1 p-6 lg:p-8 order-1 lg:order-2 overflow-auto">
        
        <div class="mb-6 border-b border-slate-200 pb-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Panel de Turnos</h1>
                <p class="text-slate-500 text-sm mt-1">Resumen del día y próximos atendidos</p>
            </div>
            <!-- Indicador de actualización -->
            <span id="live-indicator" class="flex items-center gap-1 text-xs text-green-600 font-medium">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> En vivo
            </span>
        </div>

        <!-- 1. SECCIÓN TURNOS (ARRIBA - PRIORIDAD) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-4 text-lg uppercase tracking-wide flex items-center gap-2">
                    <span class="w-3 h-3 bg-indigo-600 rounded-full"></span> Turnos Hoy ({{ turnos_hoy|length }})
                </h3>
                {% if turnos_hoy %}
                    <div class="space-y-3">
                    {% for t in turnos_hoy %}
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded border-l-4 border-indigo-600">
                            <div>
                                <p class="font-bold text-slate-800">{{ t.client_name }}</p>
                                <p class="text-xs text-slate-500">{{ t.client_phone }}</p>
                            </div>
                            <span class="font-mono text-lg font-bold text-slate-600">{{ t.time }}</span>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8 text-slate-400 border-2 border-dashed rounded">
                        <p>Sin turnos hoy.</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 mb-4 text-lg uppercase tracking-wide flex items-center gap-2">
                    <span class="w-3 h-3 bg-slate-400 rounded-full"></span> Próximos Turnos
                </h3>
                 <div class="space-y-3">
                    {% for t in proximos %}
                        <div class="flex justify-between items-center border-b pb-2">
                            <div>
                                <p class="font-medium text-slate-800">{{ t.client_name }}</p>
                                <p class="text-xs text-slate-500">{{ t.date|format_date }}</p>
                            </div>
                            <span class="font-mono text-sm text-slate-600">{{ t.time }}</span>
                        </div>
                    {% else %}
                        <p class="text-slate-400 text-sm">Sin turnos futuros.</p>
                    {% endfor %}
                    </div>
            </div>
        </div>

        <!-- 2. CALENDARIO (ABAJO - CONFIGURACIÓN) -->
        <div class="mb-8 border-t pt-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-600">Configuración de Disponibilidad</h2>
                <div class="flex gap-2">
                    <a href="{{ url_for('dashboard.index', month=month-1 if month > 1 else 12, year=year if month > 1 else year-1) }}" class="px-3 py-1 bg-white border rounded text-sm hover:bg-slate-50">&larr;</a>
                    <span class="px-3 py-1 text-sm font-bold text-slate-600">{{ month_name }} {{ year }}</span>
                    <a href="{{ url_for('dashboard.index', month=month+1 if month < 12 else 1, year=year if month < 12 else year+1) }}" class="px-3 py-1 bg-white border rounded text-sm hover:bg-slate-50">&rarr;</a>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="grid grid-cols-7 gap-1 text-center mb-2 border-b pb-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">Lun</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Mar</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Mié</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Jue</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Vie</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Sáb</span>
                    <span class="text-xs font-bold text-slate-400 uppercase">Dom</span>
                </div>
                <div class="grid grid-cols-7 gap-1">
                    {% for day in calendar_data %}
                        {% if day.type == 'empty' %}
                            <div class="h-16 bg-slate-50 rounded"></div>
                        {% else %}
                            <div class="h-16 border rounded p-1 cursor-pointer transition-all duration-150 text-xs
                                        {% if day.is_enabled %}bg-green-50 border-green-400 ring-1 ring-green-400{% endif %}
                                        {% if day.is_past %}opacity-40 bg-slate-100 border-slate-200 cursor-not-allowed{% endif %}
                                        {% if not day.is_enabled and not day.is_past %}hover:border-indigo-300 hover:bg-slate-50 border-slate-200{% endif %}"
                                 {% if not day.is_past %} 
                                    onclick="openModal('{{ day.date }}', {% if day.start %}'{{ day.start.strftime('%H:%M') }}'{% else %}'09:00'{% endif %}, {% if day.end %}'{{ day.end.strftime('%H:%M') }}'{% else %}'18:00'{% endif %}, {{ 'true' if day.is_enabled else 'false' }})" 
                                 {% endif %}>
                                <div class="flex flex-col justify-between h-full">
                                    <span class="font-bold text-slate-600 {% if day.is_enabled %}text-green-700{% endif %}">{{ day.day }}</span>
                                    {% if day.is_enabled %}
                                        <div class="text-right text-[8px] text-green-600 font-mono leading-tight">
                                            {{ day.start.strftime('%H:%M') }}<br>{{ day.end.strftime('%H:%M') }}
                                        </div>
                                    {% endif %}
                                </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- MODAL -->
<div id="day-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-2xl w-80 overflow-hidden">
        <div class="bg-slate-900 p-4 text-white">
            <h3 class="font-bold">Configurar Día</h3>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-gray-500 text-center">Define tu horario de atención.</p>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Desde</label>
                    <input type="time" id="modal-start" class="w-full border p-2 rounded text-center" value="09:00">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Hasta</label>
                    <input type="time" id="modal-end" class="w-full border p-2 rounded text-center" value="18:00">
                </div>
            </div>
            <input type="hidden" id="modal-date">
            <div class="flex gap-2 pt-2">
                <button onclick="closeModal()" class="flex-1 py-2 border rounded text-sm font-medium hover:bg-gray-50">Cancelar</button>
                <button onclick="deleteDay()" id="btn-delete" class="flex-1 py-2 bg-red-100 text-red-600 rounded text-sm font-medium hover:bg-red-200 hidden">Quitar</button>
                <button onclick="saveDay()" class="flex-1 py-2 bg-indigo-600 text-white rounded text-sm font-medium hover:bg-indigo-700">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- AUTO REFRESH SCRIPT -->
<script>
    // Recarga la página cada 30 segundos para mostrar nuevos turnos automáticamente
    setTimeout(function(){
        location.reload();
    }, 30000);

    function openModal(dateStr, startTime, endTime, isEdit) {
        const modal = document.getElementById('day-modal');
        document.getElementById('modal-date').value = dateStr;
        document.getElementById('modal-start').value = startTime;
        document.getElementById('modal-end').value = endTime;
        
        const btnDelete = document.getElementById('btn-delete');
        if(isEdit) { btnDelete.classList.remove('hidden'); } 
        else { btnDelete.classList.add('hidden'); }
        
        modal.classList.remove('hidden');
    }

    function closeModal() { document.getElementById('day-modal').classList.add('hidden'); }

    function saveDay() {
        const date = document.getElementById('modal-date').value;
        const start = document.getElementById('modal-start').value;
        const end = document.getElementById('modal-end').value;

        fetch('/dashboard/save_day', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: date, start_time: start, end_time: end})
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success'){ closeModal(); location.reload(); }
        });
    }

    function deleteDay() {
        const date = document.getElementById('modal-date').value;
        fetch('/dashboard/delete_day', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date: date})
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success'){ closeModal(); location.reload(); }
        });
    }
</script>
{% endblock %}
